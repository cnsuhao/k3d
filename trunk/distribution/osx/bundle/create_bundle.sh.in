#!/bin/sh

BUNDLE_DIR="@k3d_BINARY_DIR@/bundle/K-3D.app/Contents"

mkdir -p "${BUNDLE_DIR}/MacOS"
mkdir -p "${BUNDLE_DIR}/Resources/bin"

cd "${BUNDLE_DIR}"

# Copy binary executables ...
cp -v "@k3d_BINARY_DIR@/bin/k3d" MacOS

cp -v "@k3d_BINARY_DIR@/bin/k3d-bug-buddy" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-make-module-proxy" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderframe" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderjob" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-sl2xml" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-uuidgen" Resources/bin

# Copy libraries ...
cp -v -r "@k3d_BINARY_DIR@/lib" Resources

# Copy shared files ...
cp -v -r "@k3d_SOURCE_DIR@/share" Resources

# Setup the application icon ...
cp -v "@k3d_SOURCE_DIR@/share/icons/k3d.icns" Resources/k3d.icns

# Setup the metadata file ...
cp -v "@k3d_SOURCE_DIR@/distribution/osx/application_bundle/Info.plist" .

# Get rid of those pesky .svn directories ...
rm -rvf $(find . -name ".svn")

# Update library paths ...
install_name_tool -change @k3d_BINARY_DIR@/lib/libk3dsdk.dylib ../Resources/lib/libk3dsdk.dylib MacOS/k3d
install_name_tool -change @k3d_BINARY_DIR@/lib/libk3dsdk-half.dylib ../Resources/lib/libk3dsdk-half.dylib MacOS/k3d
install_name_tool -change @k3d_BINARY_DIR@/lib/libk3dsdk-sgi-tesselator.dylib ../Resources/lib/libk3dsdk-sgi-tesselator.dylib MacOS/k3d
install_name_tool -change @k3d_BINARY_DIR@/lib/libk3dsdk-glew.dylib ../Resources/lib/libk3dsdk-glew.dylib MacOS/k3d

