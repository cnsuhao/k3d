#!/bin/sh

# Build the wrapper executable ...
cp -v -r "@k3d_SOURCE_DIR@/distribution/osx/bundle/ScriptExec" "@k3d_BINARY_DIR@"
unset CC # Build fails if CC happens to be set (to anything other than CompileC)
cd "@k3d_BINARY_DIR@/ScriptExec"
xcodebuild -configuration Deployment clean build

# Create the bundle ...
BUNDLE_DIR="@k3d_BINARY_DIR@/bundle/K-3D.app/Contents"
mkdir -p "${BUNDLE_DIR}"
cd "${BUNDLE_DIR}"

# Setup wrapper executable ...
mkdir MacOS
cp -v "@k3d_BINARY_DIR@/ScriptExec/build/Deployment/ScriptExec.app/Contents/MacOS/ScriptExec" MacOS/K-3D

mkdir Resources
cp -v -r "@k3d_SOURCE_DIR@/distribution/osx/bundle/ScriptExec/MenuBar.nib" Resources
cp -v -r "@k3d_SOURCE_DIR@/distribution/osx/bundle/openDoc" Resources
cp -v -r "@k3d_SOURCE_DIR@/distribution/osx/bundle/script" Resources

# Copy startup script
mkdir Resources/bin
cp -v "@k3d_SOURCE_DIR@/distribution/osx/bundle/k3d-startup" Resources/bin
chmod a+x Resources/bin/k3d-startup

# Copy binary executables ...
cp -v "@k3d_BINARY_DIR@/bin/k3d" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-bug-buddy" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-make-module-proxy" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderframe" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderjob" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-sl2xml" Resources/bin
cp -v "@k3d_BINARY_DIR@/bin/k3d-uuidgen" Resources/bin

# Copy libraries ...
cp -v -r "@k3d_BINARY_DIR@/lib" Resources

# Setup the application icon ...
cp -v "@k3d_SOURCE_DIR@/share/icons/k3d.icns" Resources/K-3D.icns

# Setup the metadata file ...
cp -v "@k3d_SOURCE_DIR@/distribution/osx/bundle/Info.plist" .

# Copy shared files ...
cp -v -r "@k3d_SOURCE_DIR@/share" Resources

# Get rid of those pesky .svn directories ...
rm -rf $(find . -name ".svn")

