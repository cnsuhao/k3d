#!/bin/sh

STAGING="@CMAKE_CURRENT_BINARY_DIR@/staging"
BUNDLE="$STAGING/K-3D.app"
CONTENTS="$BUNDLE/Contents"
DISK_IMAGE="@CMAKE_CURRENT_BINARY_DIR@/K-3D @VERSION@.dmg"

# Cleanup old files
rm -rvf "$STAGING"
rm -rvf "$DISK_IMAGE"

# Create the bundle ...

# Setup wrapper script ...
mkdir -p "$CONTENTS/MacOS"
cp -v "@CMAKE_CURRENT_SOURCE_DIR@/k3d-startup" "$CONTENTS/MacOS/K-3D"
chmod a+x "$CONTENTS/MacOS/K-3D"

# Copy binary executables ...
mkdir -p "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-bug-buddy" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-make-module-proxy" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderframe" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-renderjob" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-sl2xml" "$CONTENTS/Resources/bin"
cp -v "@k3d_BINARY_DIR@/bin/k3d-uuidgen" "$CONTENTS/Resources/bin"

# Strip binary executables ...
strip -ur "$CONTENTS/Resources/bin/*"

# Copy our X11-startup helper script ...
cp -v "@CMAKE_CURRENT_SOURCE_DIR@/getdisplay.sh" "$CONTENTS/Resources/bin"
chmod a+x "$CONTENTS/Resources/bin/getdisplay.sh"

# Copy libraries ...
cp -v -r "@k3d_BINARY_DIR@/lib" "$CONTENTS/Resources"

# Strip libraries ...
strip -x "$CONTENTS/Resources/lib/*.dylib"
strip -x "$CONTENTS/Resources/lib/plugins/*.module"
strip -x "$CONTENTS/Resources/lib/uiplugins/*.module"

# Setup the application icon ...
cp -v "@k3d_SOURCE_DIR@/share/icons/k3d.icns" "$CONTENTS/Resources/K-3D.icns"

# Setup the metadata file ...
cp -v "@CMAKE_CURRENT_BINARY_DIR@/Info.plist" "$CONTENTS"

# Copy shared files ...
cp -v -r "@k3d_SOURCE_DIR@/share" "$CONTENTS/Resources"

# Get rid of those pesky .svn directories ...
rm -rf $(find "$CONTENTS" -name ".svn")

# Add a link to /Applications so users can drag-and-drop the bundle into it
ln -sf /Applications "$STAGING"

# Add a custom volume icon ...
cp -v "@CMAKE_CURRENT_SOURCE_DIR@/volume.icns" "$STAGING/.VolumeIcon.icns"

# Create a temporary read-write disk image ...
echo "Creating disk image ..."
TEMP_IMAGE="@CMAKE_CURRENT_BINARY_DIR@/temp.dmg"
hdiutil create -ov -srcfolder "$STAGING" -volname "K-3D @VERSION@" -format UDRW "$TEMP_IMAGE"

# Set the custom icon flag on the volume ...
TEMP_MOUNT="@CMAKE_CURRENT_BINARY_DIR@/mnt"
mkdir -p "$TEMP_MOUNT"
hdiutil attach -mountpoint "$TEMP_MOUNT" "$TEMP_IMAGE"
/Developer/Tools/SetFile -a C "$TEMP_MOUNT"
hdiutil detach "$TEMP_MOUNT"

# Create the final compressed read-only disk image ...
echo "Compressing disk image ..."
hdiutil convert "$TEMP_IMAGE" -format UDZO -imagekey zlib-level=9 -o "$DISK_IMAGE"

